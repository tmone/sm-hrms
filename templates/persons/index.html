{% extends "base.html" %}

{% block title %}Person Management - {{ super() }}{% endblock %}

{% block head %}
{{ super() }}
<style>
/* Highlight selected cards */
.person-card:has(input[type="checkbox"]:checked) {
    border-color: #3b82f6;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
}

.person-card:has(input[type="checkbox"]:checked) {
    background-color: rgba(59, 130, 246, 0.05);
}

/* Make checkbox more prominent when in select mode */
.select-checkbox input[type="checkbox"] {
    cursor: pointer;
}

.select-checkbox input[type="checkbox"]:hover {
    transform: scale(1.1);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Page Header -->
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-2">
            <i class="fas fa-users mr-2"></i>Detected Persons
        </h1>
        <p class="text-gray-600 dark:text-gray-400">
            Manage and merge detected persons from video processing
        </p>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 bg-blue-100 dark:bg-blue-900 rounded-full">
                    <i class="fas fa-users text-blue-600 dark:text-blue-400 text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-500 dark:text-gray-400">Total Persons</p>
                    <p class="text-2xl font-semibold text-gray-800 dark:text-white">{{ persons|length }}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 bg-green-100 dark:bg-green-900 rounded-full">
                    <i class="fas fa-images text-green-600 dark:text-green-400 text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-500 dark:text-gray-400">Total Images</p>
                    <p class="text-2xl font-semibold text-gray-800 dark:text-white">
                        {{ persons|sum(attribute='image_count') }}
                    </p>
                </div>
            </div>
        </div>
        
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 bg-purple-100 dark:bg-purple-900 rounded-full">
                    <i class="fas fa-video text-purple-600 dark:text-purple-400 text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-500 dark:text-gray-400">Videos Processed</p>
                    <p class="text-2xl font-semibold text-gray-800 dark:text-white">
                        {{ persons|map(attribute='video_id')|unique|list|length }}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Bar -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-6 p-4">
        <div class="flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center gap-4">
                <!-- Selection Controls -->
                <button onclick="toggleSelectMode()" id="selectModeBtn"
                        class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition duration-150 ease-in-out inline-flex items-center">
                    <i class="fas fa-check-square mr-2"></i>
                    <span id="selectModeText">Select Mode</span>
                </button>
                
                <!-- Merge Button (Hidden by default) -->
                <button onclick="mergeSelected()" id="mergeBtn"
                        class="hidden bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-150 ease-in-out inline-flex items-center">
                    <i class="fas fa-code-branch mr-2"></i>
                    Merge Selected (<span id="selectedCount">0</span>)
                </button>
                
                <!-- Select All/None (Hidden by default) -->
                <div id="selectionControls" class="hidden flex items-center gap-2">
                    <button onclick="selectAll()" 
                            class="text-blue-600 hover:text-blue-800 text-sm">
                        Select All
                    </button>
                    <span class="text-gray-400">|</span>
                    <button onclick="selectNone()" 
                            class="text-blue-600 hover:text-blue-800 text-sm">
                        Select None
                    </button>
                </div>
                
                <a href="{{ url_for('videos.index') }}" 
                   class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-150 ease-in-out inline-flex items-center">
                    <i class="fas fa-video mr-2"></i>
                    Process Videos
                </a>
                
                <!-- Sync Metadata Button -->
                <a href="{{ url_for('persons.sync_metadata') }}" 
                   class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition duration-150 ease-in-out inline-flex items-center">
                    <i class="fas fa-sync mr-2"></i>
                    Sync Metadata
                </a>
            </div>
            
            <!-- Search -->
            <div class="relative">
                <input type="text" 
                       id="searchPersons" 
                       placeholder="Search persons..." 
                       class="pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white">
                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
            </div>
        </div>
    </div>

    <!-- Persons Grid -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
        {% if persons %}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 p-6">
                {% for person in persons %}
                    <div class="person-card bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 hover:shadow-lg transition-shadow duration-200 relative" 
                         data-person-id="{{ person.person_id }}"
                         data-video="{{ person.video_filename }}">
                        <!-- Selection Checkbox -->
                        <div class="absolute top-2 right-2 z-10 select-checkbox hidden">
                            <input type="checkbox" 
                                   id="select-{{ person.person_id }}" 
                                   value="{{ person.person_id }}"
                                   onchange="updateSelection()"
                                   class="w-5 h-5 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                        </div>
                        
                        <!-- Person Header -->
                        <div class="p-4 border-b border-gray-200 dark:border-gray-600">
                            <h3 class="font-semibold text-lg text-gray-800 dark:text-white">
                                {{ person.person_id }}
                            </h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400 truncate" title="{{ person.video_filename }}">
                                <i class="fas fa-video mr-1"></i>{{ person.video_filename }}
                            </p>
                        </div>
                        
                        <!-- Person Images -->
                        <div class="p-4">
                            {% if person.images %}
                                <div class="grid grid-cols-3 gap-2 mb-3">
                                    {% for img in person.images[:3] %}
                                        <img src="{{ url_for('persons.serve_person_image', filepath=img.path) }}" 
                                             class="w-full h-20 object-contain bg-gray-100 dark:bg-gray-700 rounded hover:opacity-90 cursor-pointer" 
                                             alt="{{ person.person_id }}"
                                             onclick="viewPersonImages('{{ person.person_id }}')"
                                             title="Confidence: {{ '%.2f'|format(img.confidence) }}">
                                    {% endfor %}
                                </div>
                                {% if person.image_count > 3 %}
                                    <p class="text-center text-sm text-gray-500 dark:text-gray-400">
                                        +{{ person.image_count - 3 }} more images
                                    </p>
                                {% endif %}
                            {% else %}
                                <div class="text-center py-8 text-gray-400">
                                    <i class="fas fa-image fa-3x mb-2"></i>
                                    <p class="text-sm">No images</p>
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Person Stats -->
                        <div class="px-4 pb-3 space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600 dark:text-gray-400">Detections:</span>
                                <span class="font-medium text-gray-800 dark:text-white">{{ person.total_detections }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600 dark:text-gray-400">Duration:</span>
                                <span class="font-medium text-gray-800 dark:text-white">{{ '%.1f'|format(person.duration) }}s</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600 dark:text-gray-400">Confidence:</span>
                                <span class="font-medium text-gray-800 dark:text-white">{{ '%.0f%%'|format(person.avg_confidence * 100) }}</span>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="p-4 bg-gray-100 dark:bg-gray-800 rounded-b-lg">
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="viewPersonImages('{{ person.person_id }}')" 
                                        class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-3 rounded text-sm transition duration-150 ease-in-out">
                                    <i class="fas fa-images mr-1"></i>View All
                                </button>
                                {% if person.video_id %}
                                <a href="{{ url_for('videos.detail', id=person.video_id) }}" 
                                   class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-3 rounded text-sm transition duration-150 ease-in-out text-center">
                                    <i class="fas fa-video mr-1"></i>Video
                                </a>
                                {% else %}
                                <button disabled class="bg-gray-300 text-gray-500 py-2 px-3 rounded text-sm cursor-not-allowed">
                                    <i class="fas fa-video mr-1"></i>No Video
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-16">
                <i class="fas fa-users fa-4x text-gray-300 dark:text-gray-600 mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-600 dark:text-gray-400 mb-2">No Persons Detected</h3>
                <p class="text-gray-500 dark:text-gray-500 mb-6">Process some videos to detect persons</p>
                <a href="{{ url_for('videos.index') }}" 
                   class="bg-primary hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition duration-150 ease-in-out inline-flex items-center">
                    <i class="fas fa-video mr-2"></i>Go to Videos
                </a>
            </div>
        {% endif %}
    </div>
</div>

<!-- Person Images Modal -->
<div class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50" id="personImagesModal">
    <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-lg bg-white dark:bg-gray-800">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-gray-800 dark:text-white">
                <span id="modalPersonId"></span> - All Images
            </h3>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
        
        <div id="modalImagesContainer" class="max-h-[80vh] overflow-y-auto">
            <div class="flex justify-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
            </div>
        </div>
    </div>
</div>

<script>
// Search functionality
document.getElementById('searchPersons').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const personCards = document.querySelectorAll('.person-card');
    
    personCards.forEach(card => {
        const personId = card.dataset.personId.toLowerCase();
        const videoName = card.dataset.video.toLowerCase();
        const isVisible = personId.includes(searchTerm) || videoName.includes(searchTerm);
        
        card.style.display = isVisible ? 'block' : 'none';
    });
});

// Modal functions
function viewPersonImages(personId) {
    const modal = document.getElementById('personImagesModal');
    const modalPersonId = document.getElementById('modalPersonId');
    const container = document.getElementById('modalImagesContainer');
    
    modalPersonId.textContent = personId;
    modal.classList.remove('hidden');
    
    // Show loading
    container.innerHTML = `
        <div class="flex justify-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
        </div>
    `;
    
    // Fetch images
    fetch(`/persons/api/${personId}/images`)
        .then(response => response.json())
        .then(data => {
            if (data.images && data.images.length > 0) {
                let html = '<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">';
                
                data.images.forEach(img => {
                    html += `
                        <div class="relative group">
                            <img src="/persons/serve/${img.path}" 
                                 class="w-full h-40 object-contain bg-gray-100 dark:bg-gray-700 rounded-lg shadow hover:shadow-lg transition-shadow duration-200" 
                                 alt="${personId}">
                            <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-75 text-white p-2 rounded-b-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                <div class="text-xs">
                                    <div class="flex justify-between">
                                        <span>Frame: ${img.frame_number}</span>
                                        <span>${(img.confidence * 100).toFixed(0)}%</span>
                                    </div>
                                    <div>Time: ${img.timestamp.toFixed(1)}s</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-image fa-3x mb-3"></i>
                        <p>No images found</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading person images:', error);
            container.innerHTML = `
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    Error loading images
                </div>
            `;
        });
}

function closeModal() {
    document.getElementById('personImagesModal').classList.add('hidden');
}

// Close modal when clicking outside
document.getElementById('personImagesModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});

// Keyboard shortcut to close modal
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeModal();
    }
});

// Selection mode functionality
let isSelectMode = false;
let selectedPersons = new Set();

function toggleSelectMode() {
    isSelectMode = !isSelectMode;
    const selectBtn = document.getElementById('selectModeBtn');
    const selectText = document.getElementById('selectModeText');
    const mergeBtn = document.getElementById('mergeBtn');
    const selectionControls = document.getElementById('selectionControls');
    const checkboxes = document.querySelectorAll('.select-checkbox');
    
    if (isSelectMode) {
        selectBtn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
        selectBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
        selectText.textContent = 'Cancel Selection';
        selectionControls.classList.remove('hidden');
        checkboxes.forEach(cb => cb.classList.remove('hidden'));
    } else {
        selectBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        selectBtn.classList.add('bg-gray-600', 'hover:bg-gray-700');
        selectText.textContent = 'Select Mode';
        mergeBtn.classList.add('hidden');
        selectionControls.classList.add('hidden');
        checkboxes.forEach(cb => {
            cb.classList.add('hidden');
            cb.querySelector('input').checked = false;
        });
        selectedPersons.clear();
        updateSelection();
    }
}

function updateSelection() {
    selectedPersons.clear();
    const checkboxes = document.querySelectorAll('.select-checkbox input:checked');
    checkboxes.forEach(cb => selectedPersons.add(cb.value));
    
    const selectedCount = document.getElementById('selectedCount');
    const mergeBtn = document.getElementById('mergeBtn');
    
    selectedCount.textContent = selectedPersons.size;
    
    if (selectedPersons.size >= 2) {
        mergeBtn.classList.remove('hidden');
    } else {
        mergeBtn.classList.add('hidden');
    }
}

function selectAll() {
    const checkboxes = document.querySelectorAll('.select-checkbox input');
    checkboxes.forEach(cb => cb.checked = true);
    updateSelection();
}

function selectNone() {
    const checkboxes = document.querySelectorAll('.select-checkbox input');
    checkboxes.forEach(cb => cb.checked = false);
    updateSelection();
}

function mergeSelected() {
    if (selectedPersons.size < 2) {
        alert('Please select at least 2 persons to merge');
        return;
    }
    
    // Convert Set to Array and sort to get minimum ID
    const personsArray = Array.from(selectedPersons).sort();
    const primaryPerson = personsArray[0]; // Minimum ID becomes primary
    const personsToMerge = personsArray.slice(1); // Rest will be merged into primary
    
    const confirmMsg = `Merge ${personsToMerge.join(', ')} into ${primaryPerson}?\n\nThis will combine all detections and images into ${primaryPerson}.`;
    
    if (!confirm(confirmMsg)) {
        return;
    }
    
    // Create form and submit
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("persons.merge") }}';
    
    // Add CSRF token if needed
    const csrfToken = document.querySelector('meta[name="csrf-token"]');
    if (csrfToken) {
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrf_token';
        csrfInput.value = csrfToken.content;
        form.appendChild(csrfInput);
    }
    
    // Add primary person
    const primaryInput = document.createElement('input');
    primaryInput.type = 'hidden';
    primaryInput.name = 'primary_person';
    primaryInput.value = primaryPerson;
    form.appendChild(primaryInput);
    
    // Add persons to merge
    personsToMerge.forEach(personId => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'persons_to_merge';
        input.value = personId;
        form.appendChild(input);
    });
    
    document.body.appendChild(form);
    form.submit();
}
</script>
{% endblock %}